@using Microsoft.AspNetCore.Identity
@using ST10395938_POEPart2.Models
@inject UserManager<Users> UserManager
@model IEnumerable<LecturerClaim>

@{
    ViewData["Title"] = "Dashboard";

    
    var currentUser = await UserManager.GetUserAsync(User);
    var lecturerName = (currentUser != null) ? $"{currentUser.FirstName} {currentUser.LastName}" : "Lecturer Name";

    
    var lecturerClaims = Model?.Where(c => c.LecturerName == lecturerName) ?? Enumerable.Empty<LecturerClaim>();

    var submittedCount = lecturerClaims.Count();
    var approvedCount = lecturerClaims.Count(c => c.Status == "Manager Approved" || c.Status == "Coordinator Approved");
    var rejectedCount = lecturerClaims.Count(c => c.Status == "Needs Fix" || c.Status == "Rejected");
}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3 col-lg-2">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body text-center p-4">
                    <div class="mb-3">
                        <div style="width: 80px; height: 80px; background: var(--primary-navy); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                            <span style="color: white; font-size: 1.5rem;">👨‍🏫</span>
                        </div>
                    </div>
                    <h5 class="fw-bold mb-1" style="color: var(--text-primary);">@lecturerName</h5>
                    <p class="text-muted small mb-3">Lecturer</p>
                    <div class="d-grid gap-2">
                        <a asp-action="Create" class="btn btn-accent">
                            Submit New Claim
                        </a>
                        <a asp-action="MyClaims" class="btn btn-outline-primary">
                            View My Claims
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="fw-bold mb-1" style="color: var(--primary-navy);">Claims Dashboard</h1>
                    <p class="text-muted mb-0">Overview of your claim submissions and status</p>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row g-3 mb-5">
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">                            
                            </div>
                            <h3 class="fw-bold mb-1" style="color: var(--primary-navy);">@submittedCount</h3>
                            <p class="text-muted mb-0">Total Submitted</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                            </div>
                            <h3 class="fw-bold mb-1" style="color: var(--accent-teal);">@approvedCount</h3>
                            <p class="text-muted mb-0">Approved Claims</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center p-4">
                            <div class="mb-3">
                            </div>
                            <h3 class="fw-bold mb-1" style="color: #dc3545;">@rejectedCount</h3>
                            <p class="text-muted mb-0">Needs Attention</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Claims Table -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-transparent border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="fw-bold mb-0" style="color: var(--primary-navy);">Recent Claims</h4>
                        <a asp-action="MyClaims" class="btn btn-outline-primary btn-sm">
                            View All Claims
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background: var(--primary-navy); color: white;">
                                <tr>
                                    <th class="ps-4 py-3 fw-semibold">Claim ID</th>
                                    <th class="py-3 fw-semibold">Status</th>
                                    <th class="py-3 fw-semibold">Hours</th>
                                    <th class="py-3 fw-semibold">Rate</th>
                                    <th class="py-3 fw-semibold">Total Amount</th>
                                    <th class="pe-4 py-3 fw-semibold">Submitted Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (lecturerClaims.Any())
                                {
                                    @foreach (var claim in lecturerClaims.OrderByDescending(c => c.CreateAt).Take(5))
                                    {
                                        <tr>
                                            <td class="ps-4 py-3 fw-semibold" style="color: var(--text-primary);">#@claim.Id</td>
                                            <td class="py-3">
                                                <span class="badge rounded-pill px-3 py-2" style="@GetStatusBadgeStyle(claim.Status)">
                                                    @claim.Status
                                                </span>
                                            </td>
                                            <td class="py-3" style="color: var(--text-secondary);">@claim.HoursWorked</td>
                                            <td class="py-3" style="color: var(--text-secondary);">R @claim.Rate.ToString("N2")</td>
                                            <td class="py-3 fw-bold" style="color: var(--accent-teal);">R @((claim.HoursWorked * claim.Rate).ToString("N2"))</td>
                                            <td class="pe-4 py-3" style="color: var(--text-secondary);">@claim.CreateAt.ToLocalTime().ToString("yyyy-MM-dd")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center py-5">
                                            <div style="color: var(--text-secondary);">
                                                <div class="mb-3">
                                                    <div style="width: 60px; height: 60px; background: var(--background-light); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center;">
                                                        <span style="font-size: 1.5rem;">📭</span>
                                                    </div>
                                                </div>
                                                <h5 class="fw-semibold mb-2">No Claims Found</h5>
                                                <p class="mb-3">You haven't submitted any claims yet.</p>
                                                <a asp-action="Create" class="btn btn-accent">
                                                    Submit Your First Claim
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetStatusBadgeStyle(string status)
    {
        return status?.ToLower() switch
        {
            "manager approved" or "coordinator approved" => "background: rgba(25, 135, 84, 0.15); color: #198754; border: 1px solid #198754;",
            "needs fix" or "rejected" => "background: rgba(220, 53, 69, 0.15); color: #dc3545; border: 1px solid #dc3545;",
            _ => "background: rgba(108, 117, 125, 0.15); color: #6c757d; border: 1px solid #6c757d;"
        };
    }
}